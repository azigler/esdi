<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>commands/hook.js - Esdi Documentation</title>
    
    <meta name="description" content="ES6 Discord bot framework" />
    
    
    
    <meta property="og:title" content="Esdi Documentation"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://user-images.githubusercontent.com/7295363/97830418-bf410380-1c81-11eb-95cc-1b7b15d8d7eb.jpg"/>
    <meta property="og:site_name" content="Esdi Documentation"/>
    <meta property="og:url" content="https://azigler.github.io/esdi"/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://www.github.com/azigler/esdi" target="_blank" >GitHub</a></h2><h2><a href="https://www.npmjs.com/package/esdi" target="_blank" >npm</a></h2><h2><a href="https://discord.gg/HTSYNQrXam" target="_blank" >Discord</a></h2><h2><a href="https://ko-fi.com/andrewzigler" target="_blank" >Ko-fi</a></h2><h3>Classes</h3><ul><li><a href="BotController.html">BotController</a><ul class='methods'><li data-type='method'><a href="BotController.html#init">init</a></li><li data-type='method'><a href="BotController.html#login">login</a></li><li data-type='method'><a href="BotController.html#start">start</a></li><li data-type='method'><a href="BotController.html#stop">stop</a></li></ul></li><li><a href="Command.html">Command</a><ul class='members'><li data-type='member'><a href="Command.html#.clean">clean</a></li><li data-type='member'><a href="Command.html#.help">help</a></li><li data-type='member'><a href="Command.html#.hook">hook</a></li><li data-type='member'><a href="Command.html#.ping">ping</a></li><li data-type='member'><a href="Command.html#.reload">reload</a></li></ul></li><li><a href="CommandController.html">CommandController</a><ul class='methods'><li data-type='method'><a href="CommandController.html#executeCommand">executeCommand</a></li><li data-type='method'><a href="CommandController.html#findCommand">findCommand</a></li><li data-type='method'><a href="CommandController.html#init">init</a></li><li data-type='method'><a href="CommandController.html#start">start</a></li><li data-type='method'><a href="CommandController.html#stop">stop</a></li></ul></li><li><a href="DatabaseController.html">DatabaseController</a><ul class='methods'><li data-type='method'><a href="DatabaseController.html#fetchDoc">fetchDoc</a></li><li data-type='method'><a href="DatabaseController.html#init">init</a></li><li data-type='method'><a href="DatabaseController.html#loadDb">loadDb</a></li><li data-type='method'><a href="DatabaseController.html#start">start</a></li><li data-type='method'><a href="DatabaseController.html#stop">stop</a></li><li data-type='method'><a href="DatabaseController.html#stopSyncing">stopSyncing</a></li><li data-type='method'><a href="DatabaseController.html#updateDoc">updateDoc</a></li></ul></li><li><a href="Esdi.html">Esdi</a><ul class='methods'><li data-type='method'><a href="Esdi.html#load">load</a></li><li data-type='method'><a href="Esdi.html#start">start</a></li><li data-type='method'><a href="Esdi.html#stop">stop</a></li></ul></li><li><a href="Event.html">Event</a><ul class='members'><li data-type='member'><a href="Event.html#.guildCreate">guildCreate</a></li><li data-type='member'><a href="Event.html#.guildDelete">guildDelete</a></li><li data-type='member'><a href="Event.html#.guildMemberAdd">guildMemberAdd</a></li><li data-type='member'><a href="Event.html#.guildMemberRemove">guildMemberRemove</a></li><li data-type='member'><a href="Event.html#.ready">ready</a></li></ul></li><li><a href="EventController.html">EventController</a><ul class='methods'><li data-type='method'><a href="EventController.html#init">init</a></li><li data-type='method'><a href="EventController.html#loop">loop</a></li><li data-type='method'><a href="EventController.html#registerDiscordEvents">registerDiscordEvents</a></li><li data-type='method'><a href="EventController.html#start">start</a></li><li data-type='method'><a href="EventController.html#stop">stop</a></li></ul></li><li><a href="Guild.html">Guild</a></li><li><a href="GuildController.html">GuildController</a><ul class='methods'><li data-type='method'><a href="GuildController.html#addGuild">addGuild</a></li><li data-type='method'><a href="GuildController.html#fetchInitialGuilds">fetchInitialGuilds</a></li><li data-type='method'><a href="GuildController.html#init">init</a></li><li data-type='method'><a href="GuildController.html#removeGuild">removeGuild</a></li><li data-type='method'><a href="GuildController.html#start">start</a></li><li data-type='method'><a href="GuildController.html#stop">stop</a></li></ul></li><li><a href="Hook.html">Hook</a><ul class='members'><li data-type='member'><a href="Hook.html#.github-redeploy">github-redeploy</a></li><li data-type='member'><a href="Hook.html#.ko-fi">ko-fi</a></li></ul></li><li><a href="HookController.html">HookController</a><ul class='methods'><li data-type='method'><a href="HookController.html#checkHookEnabledForChannel">checkHookEnabledForChannel</a></li><li data-type='method'><a href="HookController.html#configureGitHubRedeploy">configureGitHubRedeploy</a></li><li data-type='method'><a href="HookController.html#fetchWebhookForChannelHook">fetchWebhookForChannelHook</a></li><li data-type='method'><a href="HookController.html#init">init</a></li><li data-type='method'><a href="HookController.html#start">start</a></li><li data-type='method'><a href="HookController.html#stop">stop</a></li></ul></li><li><a href="User.html">User</a><ul class='methods'><li data-type='method'><a href="User.html#addGuild">addGuild</a></li><li data-type='method'><a href="User.html#isInGuild">isInGuild</a></li><li data-type='method'><a href="User.html#removeGuild">removeGuild</a></li></ul></li><li><a href="UserController.html">UserController</a><ul class='methods'><li data-type='method'><a href="UserController.html#fetchGuildMembers">fetchGuildMembers</a></li><li data-type='method'><a href="UserController.html#init">init</a></li><li data-type='method'><a href="UserController.html#start">start</a></li><li data-type='method'><a href="UserController.html#stop">stop</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-Client.html">Client</a></li><li><a href="external-Guild.html">Guild</a></li><li><a href="external-GuildMember.html">GuildMember</a></li><li><a href="external-Message.html">Message</a></li><li><a href="external-User.html">User</a></li></ul><h3>Events</h3><ul><li><a href="Esdi.html#event:loop">loop</a></li><li><a href="Esdi.html#event:start">start</a></li><li><a href="Esdi.html#event:stop">stop</a></li><li><a href="external-Client.html#event:event:Client#guildCreate">Client#guildCreate</a></li><li><a href="external-Client.html#event:event:Client#guildDelete">Client#guildDelete</a></li><li><a href="external-Client.html#event:event:Client#guildMemberAdd">Client#guildMemberAdd</a></li><li><a href="external-Client.html#event:event:Client#guildMemberRemove">Client#guildMemberRemove</a></li><li><a href="external-Client.html#event:event:Client#ready">Client#ready</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-adding-a-custom-command.html">Adding a custom command</a></li><li><a href="tutorial-github-redeploy-global-hook-example.html">GitHub redeploy global Hook example</a></li><li><a href="tutorial-ko-fi-channel-hook-example.html">Ko-fi channel Hook example</a></li><li><a href="tutorial-setting-up-an-esdi-instance.html">Setting up an Esdi instance</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">commands/hook.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Lists all enabled {@link Hook|Hooks} for this channel, toggles the one provided, or lists all Hooks that can be enabled
 *
 * @type {Command}
 * @memberof Command
 * @name hook
 * @static
 */
module.exports = {
  name: 'hook',
  ownerOnly: true,
  usage: '[&lt;Hook name>]/[list]',
  aliases: ['hooks'],
  description: 'Lists all enabled Hooks for this channel, toggles the one provided, or lists all Hooks that can be enabled.',
  async execute ({ args, server, message }) {
    const prefix = server.controllers.get('BotController').prefix

    const HOOK_TOGGLE_TXT = `Use \`${prefix}hook &lt;Hook name>\` to toggle a Hook.`
    const HOOK_TXT = `Use \`${prefix}hook\` to see all Hooks enabled for this channel. ${HOOK_TOGGLE_TXT}`
    const HOOK_LIST_TXT = `Use \`${prefix}hook list\` to see the Hooks you can enable. ${HOOK_TOGGLE_TXT}`

    // if no arguments provided, list all Hooks enabled for this channel
    if (args.length === 0) {
      const enabledHooks = []

      // get all loaded Hooks and their database documents
      for (const h of server.hooks.values()) {
        // only consider channel type Hooks
        if (h.type !== 'channel') continue

        // fetch this Hook's database document
        const doc = await server.controllers.get('DatabaseController').fetchDoc({ db: 'hook', id: h.name })
        const channels = doc.channelHookPairs.map(h => h[0])

        // get all channels with this Hook enabled
        for (const c of channels) {
          // if found, know that this Hook is enabled for this channel
          if (message.channel.id === c) {
            enabledHooks.push(`\`\`\`${h.name} - ${h.description}\`\`\``)
          }
        }
      }

      // if there are Hooks enabled for this channel, announce them
      if (enabledHooks.length > 0) {
        enabledHooks.unshift('**Hooks enabled for this channel:**')
        enabledHooks.push(HOOK_LIST_TXT)
        message.channel.send(enabledHooks, { split: true })
      // otherwise, provide help about enabling Hooks
      } else {
        message.channel.send(`There are no Hooks enabled for this channel. ${HOOK_LIST_TXT}`)
      }
    // if the argument provided is 'list', show a list of Hooks that can be enabled for this channel
    } else if (args[0].toLowerCase() === 'list') {
      const availableHooks = []

      // get all loaded Hooks and their database documents
      for (const h of server.hooks.values()) {
        // only consider channel type Hooks
        if (h.type !== 'channel') continue

        // fetch this Hook's database document
        const doc = await server.controllers.get('DatabaseController').fetchDoc({ db: 'hook', id: h.name })
        const channels = doc.channelHookPairs.map(h => h[0])

        let enabled = false
        // get all channels with this Hook enabled
        for (const c of channels) {
          // if found, know that this Hook is enabled for this channel
          if (message.channel.id === c) {
            enabled = true
          }
        }

        // if the Hook is not already enabled, add it to the array of available Hooks
        if (!enabled) {
          availableHooks.push(`\`\`\`${h.name} - ${h.description}\`\`\``)
        }
      }

      // if there are Hooks that can be enabled, announce them
      if (availableHooks.length > 0) {
        availableHooks.unshift('**Hooks available for this channel:**')
        availableHooks.push(HOOK_TXT)
        message.channel.send(availableHooks, { split: true })
      // otherwise, announce none available
      } else {
        message.channel.send(`There are no Hooks available for this channel. ${HOOK_TXT}`)
      }
    // otherwise, toggle the provided Hook
    } else {
      const hook = server.hooks.get(args[0])

      // stop if Hook not found
      if (!hook) return message.reply('that Hook does not exist.')

      // stop if Hook is not a channel type
      if (hook.type !== 'channel') return message.reply('that Hook cannot be enabled for a channel.')

      let msg

      try {
        let hookData,
          channelHook,
          channelWebhookId

        // fetch this Hook's database document
        hookData = await server.controllers.get('DatabaseController').fetchDoc({ db: 'hook', id: hook.name })

        // if the document is deleted or missing, initialize it
        if (hookData.status === 404 || !hookData.channelHookPairs) {
          hookData = await server.controllers.get('DatabaseController').updateDoc({
            db: 'hook',
            id: hook.name,
            payload: {
              ...hookData.payload,
              channelHookPairs: []
            }
          })
        }

        // get all channels with this Hook enabled
        const channels = hookData.channelHookPairs.map(h => h[0])

        // if Hook is enabled for this channel, disable it
        if (channels.find(c => c === message.channel.id)) {
          // do any Hook-specific cleanup before disabling the Hook for this channel
          await hook.disable({ server, channel: message.channel })

          // get the Hook's webhook ID from the document
          channelWebhookId = hookData.channelHookPairs.find(p => p[0] === message.channel.id)[1]

          // fetch this channel's webhooks and delete the one with the above ID
          channelHook = await message.channel.fetchWebhooks()
          channelHook = channelHook.find(hook => hook.id === channelWebhookId)
          if (channelHook) {
            channelHook.delete()
          }

          // update the database document to remove the channel and webhook ID pair
          const payload = hookData.channelHookPairs.filter(p => p[1] !== channelWebhookId)
          server.controllers.get('DatabaseController').updateDoc({
            db: 'hook',
            id: hook.name,
            payload: {
              ...hookData.payload,
              channelHookPairs: [...(payload)]
            }
          })

          // announce successfully disabling
          msg = `The \`${hook.name}\` Hook is now **disabled** for this channel.`
          message.channel.send(msg)
          msg = `${hook.name} Hook is now disabled for Channel&lt;${message.channel.id}>`
          console.log(msg)

        // otherwise, enable the Hook for this channel
        } else {
          // enable the Hook for this channel
          const newlyEnabledHook = await hook.enable({ server, channel: message.channel })

          // check if enabling returned a webhook before proceeding
          if (newlyEnabledHook.constructor.name !== 'Webhook') {
            msg = `The result of enabling ${hookData._id} Hook for for Channel&lt;${message.channel.id}> was not a valid webhook`

            message.channel.send(msg)
            msg = `${hook.name} Hook is now enabled for Channel&lt;${message.channel.id}>`
            return console.log(msg)
          }

          // update the database document to add this channel and webhook ID pair
          const payload = hookData.channelHookPairs.filter(p => p[0] !== message.channel.id)
          server.controllers.get('DatabaseController').updateDoc({
            db: 'hook',
            id: hook.name,
            payload: {
              ...hookData.payload,
              channelHookPairs: [...(payload), [message.channel.id, newlyEnabledHook.id]]
            }
          })

          // announce successfully enabling
          msg = `The \`${hook.name}\` Hook is now **enabled** for this channel.`
          message.channel.send(msg)
          msg = `${hook.name} Hook is now enabled for Channel&lt;${message.channel.id}>`
          console.log(msg)
        }
      } catch (e) {
        msg = `An error occurred while toggling \`${hook.name}\` Hook for this channel.`
        message.channel.send(msg)
        msg = `An error occurred while toggling ${hook.name} Hook for Channel&lt;${message.channel.id}>`
        console.log(msg, e)
      }
    }
  }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Sun Dec 06 2020 15:16:44 GMT-0800 (Pacific Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



    <script src="./jsdoc.js"></script>
    
    <link type="text/css" rel="stylesheet" href="./jsdoc.css">
    
</body>
</html>
