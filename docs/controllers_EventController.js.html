<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>controllers/EventController.js - Esdi Documentation</title>
    
    <meta name="description" content="ES6 Discord bot framework" />
    
    
    
    <meta property="og:title" content="Esdi Documentation"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://user-images.githubusercontent.com/7295363/97830418-bf410380-1c81-11eb-95cc-1b7b15d8d7eb.jpg"/>
    <meta property="og:site_name" content="Esdi Documentation"/>
    <meta property="og:url" content="https://azigler.github.io/esdi"/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://www.github.com/azigler/esdi" target="_blank" >GitHub</a></h2><h2><a href="https://www.npmjs.com/package/esdi" target="_blank" >npm</a></h2><h2><a href="https://discord.gg/HTSYNQrXam" target="_blank" >Discord</a></h2><h2><a href="https://ko-fi.com/andrewzigler" target="_blank" >Ko-fi</a></h2><h3>Classes</h3><ul><li><a href="Command.html">Command</a><ul class='members'><li data-type='member'><a href="Command.html#.clean">clean</a></li><li data-type='member'><a href="Command.html#.event">event</a></li><li data-type='member'><a href="Command.html#.help">help</a></li><li data-type='member'><a href="Command.html#.hook">hook</a></li><li data-type='member'><a href="Command.html#.ping">ping</a></li><li data-type='member'><a href="Command.html#.prefix">prefix</a></li><li data-type='member'><a href="Command.html#.reload">reload</a></li><li data-type='member'><a href="Command.html#.status">status</a></li></ul></li><li><a href="CommandController.html">CommandController</a><ul class='methods'><li data-type='method'><a href="CommandController.html#determinePrefix">determinePrefix</a></li><li data-type='method'><a href="CommandController.html#executeCommand">executeCommand</a></li><li data-type='method'><a href="CommandController.html#findCommand">findCommand</a></li><li data-type='method'><a href="CommandController.html#init">init</a></li><li data-type='method'><a href="CommandController.html#start">start</a></li><li data-type='method'><a href="CommandController.html#stop">stop</a></li></ul></li><li><a href="DatabaseController.html">DatabaseController</a><ul class='methods'><li data-type='method'><a href="DatabaseController.html#fetchDoc">fetchDoc</a></li><li data-type='method'><a href="DatabaseController.html#init">init</a></li><li data-type='method'><a href="DatabaseController.html#loadDb">loadDb</a></li><li data-type='method'><a href="DatabaseController.html#start">start</a></li><li data-type='method'><a href="DatabaseController.html#stop">stop</a></li><li data-type='method'><a href="DatabaseController.html#stopSyncing">stopSyncing</a></li><li data-type='method'><a href="DatabaseController.html#updateDoc">updateDoc</a></li></ul></li><li><a href="DiscordController.html">DiscordController</a><ul class='methods'><li data-type='method'><a href="DiscordController.html#buildEmbed">buildEmbed</a></li><li data-type='method'><a href="DiscordController.html#buildEmbedFields">buildEmbedFields</a></li><li data-type='method'><a href="DiscordController.html#buildEmbedFieldValues">buildEmbedFieldValues</a></li><li data-type='method'><a href="DiscordController.html#buildStatusEmbed">buildStatusEmbed</a></li><li data-type='method'><a href="DiscordController.html#init">init</a></li><li data-type='method'><a href="DiscordController.html#login">login</a></li><li data-type='method'><a href="DiscordController.html#start">start</a></li><li data-type='method'><a href="DiscordController.html#stop">stop</a></li></ul></li><li><a href="Esdi.html">Esdi</a><ul class='methods'><li data-type='method'><a href="Esdi.html#determineMemory">determineMemory</a></li><li data-type='method'><a href="Esdi.html#determineProcessor">determineProcessor</a></li><li data-type='method'><a href="Esdi.html#determineUptime">determineUptime</a></li><li data-type='method'><a href="Esdi.html#load">load</a></li><li data-type='method'><a href="Esdi.html#start">start</a></li><li data-type='method'><a href="Esdi.html#stop">stop</a></li></ul></li><li><a href="Event.html">Event</a><ul class='members'><li data-type='member'><a href="Event.html#.guildCreate">guildCreate</a></li><li data-type='member'><a href="Event.html#.guildDelete">guildDelete</a></li><li data-type='member'><a href="Event.html#.guildMemberAdd">guildMemberAdd</a></li><li data-type='member'><a href="Event.html#.guildMemberRemove">guildMemberRemove</a></li><li data-type='member'><a href="Event.html#.process-monitor">process-monitor</a></li><li data-type='member'><a href="Event.html#.rateLimit">rateLimit</a></li><li data-type='member'><a href="Event.html#.ready">ready</a></li></ul></li><li><a href="EventController.html">EventController</a><ul class='methods'><li data-type='method'><a href="EventController.html#fetchEventContext">fetchEventContext</a></li><li data-type='method'><a href="EventController.html#init">init</a></li><li data-type='method'><a href="EventController.html#initializeIfMissing">initializeIfMissing</a></li><li data-type='method'><a href="EventController.html#loop">loop</a></li><li data-type='method'><a href="EventController.html#registerDiscordEvents">registerDiscordEvents</a></li><li data-type='method'><a href="EventController.html#start">start</a></li><li data-type='method'><a href="EventController.html#stop">stop</a></li><li data-type='method'><a href="EventController.html#updateLocalEventContexts">updateLocalEventContexts</a></li></ul></li><li><a href="Guild.html">Guild</a><ul class='methods'><li data-type='method'><a href="Guild.html#.User#serialize">User#serialize</a></li><li data-type='method'><a href="Guild.html#hydrate">hydrate</a></li></ul></li><li><a href="GuildController.html">GuildController</a><ul class='methods'><li data-type='method'><a href="GuildController.html#addGuild">addGuild</a></li><li data-type='method'><a href="GuildController.html#fetchInitialGuilds">fetchInitialGuilds</a></li><li data-type='method'><a href="GuildController.html#init">init</a></li><li data-type='method'><a href="GuildController.html#removeGuild">removeGuild</a></li><li data-type='method'><a href="GuildController.html#start">start</a></li><li data-type='method'><a href="GuildController.html#stop">stop</a></li></ul></li><li><a href="Hook.html">Hook</a><ul class='members'><li data-type='member'><a href="Hook.html#.github-redeploy">github-redeploy</a></li><li data-type='member'><a href="Hook.html#.ko-fi">ko-fi</a></li></ul><ul class='methods'><li data-type='method'><a href="Hook.html#checkEnabledForContext">checkEnabledForContext</a></li></ul></li><li><a href="HookController.html">HookController</a><ul class='methods'><li data-type='method'><a href="HookController.html#init">init</a></li><li data-type='method'><a href="HookController.html#start">start</a></li><li data-type='method'><a href="HookController.html#stop">stop</a></li></ul></li><li><a href="User.html">User</a><ul class='methods'><li data-type='method'><a href="User.html#addGuild">addGuild</a></li><li data-type='method'><a href="User.html#isInGuild">isInGuild</a></li><li data-type='method'><a href="User.html#removeGuild">removeGuild</a></li></ul></li><li><a href="UserController.html">UserController</a><ul class='methods'><li data-type='method'><a href="UserController.html#fetchGuildMembers">fetchGuildMembers</a></li><li data-type='method'><a href="UserController.html#init">init</a></li><li data-type='method'><a href="UserController.html#start">start</a></li><li data-type='method'><a href="UserController.html#stop">stop</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-Client.html">Client</a></li><li><a href="external-Guild.html">Guild</a></li><li><a href="external-GuildMember.html">GuildMember</a></li><li><a href="external-Message.html">Message</a></li><li><a href="external-User.html">User</a></li></ul><h3>Events</h3><ul><li><a href="Esdi.html#event:loop">loop</a></li><li><a href="Esdi.html#event:start">start</a></li><li><a href="Esdi.html#event:stop">stop</a></li><li><a href="external-Client.html#event:event:Client#guildCreate">Client#guildCreate</a></li><li><a href="external-Client.html#event:event:Client#guildDelete">Client#guildDelete</a></li><li><a href="external-Client.html#event:event:Client#guildMemberAdd">Client#guildMemberAdd</a></li><li><a href="external-Client.html#event:event:Client#guildMemberRemove">Client#guildMemberRemove</a></li><li><a href="external-Client.html#event:event:Client#ready">Client#ready</a></li></ul><h3>Namespaces</h3><ul><li><a href="ZigUtils.html">ZigUtils</a><ul class='methods'><li data-type='method'><a href="ZigUtils.html#.capitalize">capitalize</a></li><li data-type='method'><a href="ZigUtils.html#.parseIntervalString">parseIntervalString</a></li></ul></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-adding-a-custom-command.html">Adding a custom command</a></li><li><a href="tutorial-github-redeploy-global-hook-example.html">github-redeploy global Hook example</a></li><li><a href="tutorial-ko-fi-channel-hook-example.html">ko-fi channel Hook example</a></li><li><a href="tutorial-process-monitor-global-interval-event-example.html">process-monitor global interval Event example</a></li><li><a href="tutorial-setting-up-an-esdi-instance.html">Setting up an Esdi instance</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">controllers/EventController.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Controller for {@link Event|Events}
 *
 * @class
 */
class EventController {
  /**
   * Initializes a new EventController
   *
   * @param {Object} config configuration object
   * @param {Esdi} config.server Esdi server instance
   * @memberof EventController
   */
  init ({ server }) {
    this.server = server
    this.intervalEvents = new Map()
  }

  /**
   * Starts the EventController
   *
   * @listens Esdi#start
   * @memberof EventController
   */
  async start () {
    console.log('[#] Starting EventController...')

    // get all loaded interval Events and their database documents
    for (const e of this.server.events.values()) {
      // only consider interval Events
      if (e.type !== 'interval') continue

      // fetch this Event's database document
      let doc = await this.server.controllers.get('DatabaseController').fetchDoc({ db: 'event', id: e.name })

      // if missing, initialize this Event's database document
      doc = await this.initializeIfMissing(this.server, e, doc)

      // fetch the array of contexts with this Event enabled
      const allContexts = doc.contextTimestampPairs.map(p => p[0])

      // keep only enabled contexts
      const enabledContexts = []
      for (const c of allContexts) {
        const contextDoc = await this.server.controllers.get('DatabaseController').fetchDoc({
          db: 'event',
          id: `${e.name}_${c}`
        })
        if (contextDoc.enabled) enabledContexts.push(c)
      }

      // remember the interval Event and its array of enabled contexts
      this.intervalEvents.set(e.name, enabledContexts)
    }
  }

  /**
   * Stops the EventController
   *
   * @listens Esdi#stop
   * @memberof EventController
   */
  stop () {
    console.log('[#] Stopping EventController...')
    this.intervalEvents.clear()
  }

  /**
   * Called every {@link Esdi} server loop
   *
   * @listens Esdi#loop
   * @memberof EventController
   */
  loop () {
    // iterate over the loaded interval Events and fire the handler for each enabled context
    this.intervalEvents.forEach(async (contexts, eventName) => {
      const event = Array.from(this.server.events.values()).filter(e => e.name === eventName)[0]

      // fetch this Event's database document
      let doc = await this.server.controllers.get('DatabaseController').fetchDoc({ db: 'event', id: event.name })

      // if missing, initialize this Event's database document
      doc = await this.initializeIfMissing(this.server, event, doc)

      // iterate over each context
      for (const context of contexts) {
        const timestamp = doc.contextTimestampPairs.find(pair => pair[0] === context)[1]

        // fetch database document for each context to check if enabled
        const { enabled, config } = await this.server.controllers.get('DatabaseController').fetchDoc({
          db: 'event',
          id: `${event.name}_${context}`
        })
        // apply custom config for this context
        const interval = (config &amp;&amp; config.interval ? config.interval : event.interval)

        // determine the Event's timing interval
        const { day, hr, min, sec } = this.server.utils.parseIntervalString(interval)

        const intervalAmount = (sec * 1000) + (min * 60000) + (hr * 3600000) + (day * 86400000)

        const now = Date.now()
        const nextInterval = timestamp + intervalAmount

        // if it's time for this Event to fire for this context and it is enabled
        if (now > nextInterval &amp;&amp; enabled) {
          // determine the capitalized name of this context
          const contextName = (event.context === 'guild' ? 'Server' : 'Channel')

          // check if bot can see context
          let con
          try {
            // determine this Event's context
            const fetchedContext = await this.fetchEventContext({
              context: {
                id: context
              },
              event
            })

            con = {
              type: event.context,
              ctx: (event.context === 'global' ? 'global' : fetchedContext)
            }
          } catch (e) {
            // update locally to avoid handling every loop
            const local = this.server.controllers.get('EventController').intervalEvents.get(event.name)
            this.server.controllers.get('EventController').intervalEvents.set(event.name, [...local.filter(c => c !== context)])

            // save the Event as disabled in the context's database document
            await this.server.controllers.get('DatabaseController').updateDoc({
              db: 'event',
              id: `${event.name}_${context}`,
              payload: {
                enabled: false
              }
            })

            return console.log(`Bot doesn't know about ${contextName}&lt;${context}> for ${event.name} Event:`, e)
          }

          // update this context's timestamp in the database document for this Event
          const payload = doc.contextTimestampPairs.filter(p => p[0] !== context)
          await this.server.controllers.get('DatabaseController').updateDoc({
            db: 'event',
            id: event.name,
            payload: {
              contextTimestampPairs: [...payload, [context, now]]
            }
          })

          // update the timestamp in this context's database document for this Event
          await this.server.controllers.get('DatabaseController').updateDoc({
            db: 'event',
            id: `${event.name}_${context}`,
            payload: {
              lastHandled: now
            }
          })

          // fire the handler for this Event for this context
          event.handler({ server: this.server, context: con.ctx })

          // announce handling of Event
          console.log(`${event.name} Event was handled ${con.type === 'global' ? 'globally' : `for ${this.server.utils.capitalize(con.type)}&lt;${con.ctx.id}>`} @ ${new Date().toLocaleString()} PT`)
        }
      }
    })
  }

  /**
   * Registers Discord Events to the provided discord.js Client
   *
   * @param {external:Client} client discord.js Client
   * @memberof EventController
   */
  registerDiscordEvents (client) {
    this.server.events.forEach(event => {
      if (!event.discordEventName || !event.handler || event.type !== 'discord') return
      client.on(event.discordEventName, event.handler.bind(client.discordController.server))
    })
  }

  /**
   * Fetches the discord.js object representing the provided context
   *
   * @param {Object} config configuration object
   * @param {Object} config.context context configuration object
   * @param {Event} config.event Event for context
   * @returns {Object|String} context object or 'global' for global context
   * @memberof EventController
   */
  async fetchEventContext ({ context, event }) {
    if (event.context !== 'global') {
      if (event.context === 'guild') {
        const result = await this.server.controllers.get('DiscordController').client.guilds.fetch(context.id)
        return result
      } else if (event.context === 'channel') {
        const result = await this.server.controllers.get('DiscordController').client.channels.fetch(context.id)
        return result
      }
    } else {
      return 'global'
    }
  }

  /**
   * Updates the interval Event contexts stored on the local Esdi server instance
   *
   * @param {Object} config configuration object
   * @param {Event} config.event Event for which to update available contexts
   * @param {Function} config.filterFunc function that filters the context array
   * @param {String} config.newContext ID of new context to add to array
   * @memberof EventController
   */
  updateLocalEventContexts ({ event, filterFunc, newContext }) {
    const local = this.server.controllers.get('EventController').intervalEvents.get(event.name)

    if (newContext) {
      this.server.controllers.get('EventController').intervalEvents.set(event.name, [...local.filter(c => filterFunc(c)), newContext])
    } else {
      this.server.controllers.get('EventController').intervalEvents.set(event.name, local.filter(c => filterFunc(c)))
    }
  }

  /**
   * Helper method that initializes the database document if missing
   *
   * @param {Esdi} server Esdi server instance
   * @param {Event} event Event for which to initialize database document
   * @param {Object} doc database document to check before starting
   * @memberof EventController
   */
  async initializeIfMissing (server, event, doc) {
    if (doc.status === 404 || !doc.contextTimestampPairs) {
      return await server.controllers.get('DatabaseController').updateDoc({
        db: 'event',
        id: event.name,
        payload: {
          contextTimestampPairs: []
        }
      })
    } else {
      return doc
    }
  }
}

// factory
module.exports = new EventController()
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Wed Dec 30 2020 13:23:10 GMT-0800 (Pacific Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



    <script src="./jsdoc.js"></script>
    
    <link type="text/css" rel="stylesheet" href="./jsdoc.css">
    
</body>
</html>
