<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Tutorial: GitHub redeploy global Hook example - Esdi Documentation</title>
    
    <meta name="description" content="ES6 Discord bot framework" />
    
    
    
    <meta property="og:title" content="Esdi Documentation"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://user-images.githubusercontent.com/7295363/97830418-bf410380-1c81-11eb-95cc-1b7b15d8d7eb.jpg"/>
    <meta property="og:site_name" content="Esdi Documentation"/>
    <meta property="og:url" content="https://azigler.github.io/esdi"/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://www.github.com/azigler/esdi" target="_blank" >GitHub</a></h2><h2><a href="https://www.npmjs.com/package/esdi" target="_blank" >npm</a></h2><h2><a href="https://discord.gg/HTSYNQrXam" target="_blank" >Discord</a></h2><h2><a href="https://ko-fi.com/andrewzigler" target="_blank" >Ko-fi</a></h2><h3>Classes</h3><ul><li><a href="BotController.html">BotController</a><ul class='methods'><li data-type='method'><a href="BotController.html#init">init</a></li><li data-type='method'><a href="BotController.html#login">login</a></li><li data-type='method'><a href="BotController.html#start">start</a></li><li data-type='method'><a href="BotController.html#stop">stop</a></li></ul></li><li><a href="Command.html">Command</a><ul class='members'><li data-type='member'><a href="Command.html#.clean">clean</a></li><li data-type='member'><a href="Command.html#.help">help</a></li><li data-type='member'><a href="Command.html#.hook">hook</a></li><li data-type='member'><a href="Command.html#.ping">ping</a></li><li data-type='member'><a href="Command.html#.reload">reload</a></li></ul></li><li><a href="CommandController.html">CommandController</a><ul class='methods'><li data-type='method'><a href="CommandController.html#executeCommand">executeCommand</a></li><li data-type='method'><a href="CommandController.html#findCommand">findCommand</a></li><li data-type='method'><a href="CommandController.html#init">init</a></li><li data-type='method'><a href="CommandController.html#start">start</a></li><li data-type='method'><a href="CommandController.html#stop">stop</a></li></ul></li><li><a href="DatabaseController.html">DatabaseController</a><ul class='methods'><li data-type='method'><a href="DatabaseController.html#fetchDoc">fetchDoc</a></li><li data-type='method'><a href="DatabaseController.html#init">init</a></li><li data-type='method'><a href="DatabaseController.html#loadDb">loadDb</a></li><li data-type='method'><a href="DatabaseController.html#start">start</a></li><li data-type='method'><a href="DatabaseController.html#stop">stop</a></li><li data-type='method'><a href="DatabaseController.html#stopSyncing">stopSyncing</a></li><li data-type='method'><a href="DatabaseController.html#updateDoc">updateDoc</a></li></ul></li><li><a href="Esdi.html">Esdi</a><ul class='methods'><li data-type='method'><a href="Esdi.html#load">load</a></li><li data-type='method'><a href="Esdi.html#start">start</a></li><li data-type='method'><a href="Esdi.html#stop">stop</a></li></ul></li><li><a href="Event.html">Event</a><ul class='members'><li data-type='member'><a href="Event.html#.guildCreate">guildCreate</a></li><li data-type='member'><a href="Event.html#.guildDelete">guildDelete</a></li><li data-type='member'><a href="Event.html#.guildMemberAdd">guildMemberAdd</a></li><li data-type='member'><a href="Event.html#.guildMemberRemove">guildMemberRemove</a></li><li data-type='member'><a href="Event.html#.ready">ready</a></li></ul></li><li><a href="EventController.html">EventController</a><ul class='methods'><li data-type='method'><a href="EventController.html#init">init</a></li><li data-type='method'><a href="EventController.html#loop">loop</a></li><li data-type='method'><a href="EventController.html#registerDiscordEvents">registerDiscordEvents</a></li><li data-type='method'><a href="EventController.html#start">start</a></li><li data-type='method'><a href="EventController.html#stop">stop</a></li></ul></li><li><a href="Guild.html">Guild</a></li><li><a href="GuildController.html">GuildController</a><ul class='methods'><li data-type='method'><a href="GuildController.html#addGuild">addGuild</a></li><li data-type='method'><a href="GuildController.html#fetchInitialGuilds">fetchInitialGuilds</a></li><li data-type='method'><a href="GuildController.html#init">init</a></li><li data-type='method'><a href="GuildController.html#removeGuild">removeGuild</a></li><li data-type='method'><a href="GuildController.html#start">start</a></li><li data-type='method'><a href="GuildController.html#stop">stop</a></li></ul></li><li><a href="Hook.html">Hook</a><ul class='members'><li data-type='member'><a href="Hook.html#.github-redeploy">github-redeploy</a></li><li data-type='member'><a href="Hook.html#.ko-fi">ko-fi</a></li></ul></li><li><a href="HookController.html">HookController</a><ul class='methods'><li data-type='method'><a href="HookController.html#checkHookEnabledForChannel">checkHookEnabledForChannel</a></li><li data-type='method'><a href="HookController.html#configureGitHubRedeploy">configureGitHubRedeploy</a></li><li data-type='method'><a href="HookController.html#fetchWebhookForChannelHook">fetchWebhookForChannelHook</a></li><li data-type='method'><a href="HookController.html#init">init</a></li><li data-type='method'><a href="HookController.html#start">start</a></li><li data-type='method'><a href="HookController.html#stop">stop</a></li></ul></li><li><a href="User.html">User</a><ul class='methods'><li data-type='method'><a href="User.html#addGuild">addGuild</a></li><li data-type='method'><a href="User.html#isInGuild">isInGuild</a></li><li data-type='method'><a href="User.html#removeGuild">removeGuild</a></li></ul></li><li><a href="UserController.html">UserController</a><ul class='methods'><li data-type='method'><a href="UserController.html#fetchGuildMembers">fetchGuildMembers</a></li><li data-type='method'><a href="UserController.html#init">init</a></li><li data-type='method'><a href="UserController.html#start">start</a></li><li data-type='method'><a href="UserController.html#stop">stop</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-Client.html">Client</a></li><li><a href="external-Guild.html">Guild</a></li><li><a href="external-GuildMember.html">GuildMember</a></li><li><a href="external-Message.html">Message</a></li><li><a href="external-User.html">User</a></li></ul><h3>Events</h3><ul><li><a href="Esdi.html#event:loop">loop</a></li><li><a href="Esdi.html#event:start">start</a></li><li><a href="Esdi.html#event:stop">stop</a></li><li><a href="external-Client.html#event:event:Client#guildCreate">Client#guildCreate</a></li><li><a href="external-Client.html#event:event:Client#guildDelete">Client#guildDelete</a></li><li><a href="external-Client.html#event:event:Client#guildMemberAdd">Client#guildMemberAdd</a></li><li><a href="external-Client.html#event:event:Client#guildMemberRemove">Client#guildMemberRemove</a></li><li><a href="external-Client.html#event:event:Client#ready">Client#ready</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-adding-a-custom-command.html">Adding a custom command</a></li><li><a href="tutorial-github-redeploy-global-hook-example.html">GitHub redeploy global Hook example</a></li><li><a href="tutorial-ko-fi-channel-hook-example.html">Ko-fi channel Hook example</a></li><li><a href="tutorial-setting-up-an-esdi-instance.html">Setting up an Esdi instance</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">Tutorial: GitHub redeploy global Hook example</h1>
    

    <section>

<header>
    

    <h2>GitHub redeploy global Hook example</h2>
</header>

<article>
    <p>A global Hook is tied to the Esdi server itself, not any particular channel. <strong>All global Hooks are disabled by default and must fire their <code>init()</code> function to become enabled.</strong> For this example, we're going to look at a Hook that redeploys the Esdi instance after receiving a GitHub webhook.</p>
<p>The <a href="Hook.html#.github-redeploy"><code>github-redeploy</code> Hook</a> is included in <a href="https://github.com/azigler/esdi/releases/tag/v1.1.0"><code>v1.1.0</code></a> and higher, and you can see the code for it <a href="hooks_github-redeploy.js.html">here</a>. Please refer to this code as we look at the different parts of the global Hook.</p>
<p><strong>By the way, if you just want to use the pre-existing <a href="Hook.html#.github-redeploy"><code>github-redeploy</code> Hook</a>, implement the <code><a href="HookController.html#configureGitHubRedeploy">HookController#configureGitHubRedeploy</a></code> method to fire after starting the server.</strong> The following is an example:</p>
<pre class="prettyprint source lang-js"><code>// ... setup

server.start()

server.controllers.get('HookController').configureGitHubRedeploy({
  repo: 'your-url-to-github-repo',
  command: 'pm2 restart esdi-dev',
  path: '~/esdi-dev',
  secret: 'your-github-webhook-secret'
})
</code></pre>
<p>The <code><a href="HookController.html#configureGitHubRedeploy">HookController#configureGitHubRedeploy</a></code> method is just a wrapper around <code>init()</code> for <a href="Hook.html#.github-redeploy"><code>github-redeploy</code></a>.</p>
<p>Now, on to examining <a href="Hook.html#.github-redeploy"><code>github-redeploy</code></a>. The Hook has a function called <code>init()</code> that will return a <a href="https://hapi.dev/tutorials/routing/">hapi route object</a> to configure the Hook for the server.</p>
<p>The <code>init()</code> method can take any set of arguments that the developer (that's you) might need to have the desired result. Long story short: pass in what you need. If you need nothing, pass in nothing (e.g., <code>init()</code>). Let's look at the arguments this particular <code>init()</code> method takes:</p>
<pre class="prettyprint source lang-js"><code>init({ repo, secret, command, path, reset }) { // ... }
</code></pre>
<p>The <code>repo</code> argument is the GitHub repository URL. If your repository is private, then you will need to include authentication in the URL (e.g., if your username is <code>andrew</code>, your password is <code>sunflower</code>, and your private repository is <code>my-esdi</code> then <code>repo</code> should be <code>https://andrew:sunflower@github.com/andrew/my-esdi</code>). If you need to escape any special characters in your password (e.g., <code>!</code>) then be sure to escape them with a slash (e.g., <code>\!</code>).</p>
<p>Next, if you have a secret for your GitHub webhook (recommended), include it as <code>secret</code> <em>(optional)</em>.</p>
<p>The <code>command</code> argument is the terminal command you want to fire to redeploy your server (e.g., <code>pm2 restart esdi</code>).</p>
<p>The project directory is <code>path</code> and <code>reset</code> <em>(optional)</em> decides whether or not to invoke <code>git reset --hard</code> for a force update. This is a personal preference. If you are actively developing on your live server directory files, then you should keep <code>reset</code> as <code>false</code>, which it is by default. Setting it to <code>true</code> means the repository files will reset to match the most updated version of the repository, which will overwrite any local pending changings.</p>
<p>These corresponding arguments demonstrate how the <code><a href="HookController.html#configureGitHubRedeploy">HookController#configureGitHubRedeploy</a></code> method is just a wrapper around <code>init()</code> for <a href="Hook.html#.github-redeploy"><code>github-redeploy</code></a>, as mentioned above.</p>
<p>As described previously, the <code>init()</code> method returns the <a href="https://hapi.dev/tutorials/routing/">hapi route object</a>. This object has three required properties: <code>method</code>, <code>path</code>, and <code>handler()</code>. Let's look at this object's properties:</p>
<pre class="prettyprint source lang-js"><code>{
  method: 'POST',
  path: '/hook/github-redeploy',
  handler: (request, h) => { // ... }
}
</code></pre>
<p>The <code>method</code> property can be any valid HTTP method, or an array of methods. The <code>path</code> property is the relative URL endpoint for this Hook. This would be the relative Hook server path to which any corresponding third-party webhook should send its request. In this case, the <code>handler()</code> function is triggered by a <code>POST</code> request on the Hook server's <code>/hook/github-redeploy</code> path.</p>
<p>The <code>handler()</code> function is where the magic happens. This is the function that fires when the <code>path</code> receives the specified <code>method</code>. Let's look at the <code>handler()</code> function for <a href="Hook.html#.github-redeploy"><code>github-redeploy</code></a>:</p>
<pre class="prettyprint source lang-js"><code>handler: (request, h) => {
  // helper function that executes the redeploy
  function _exec () {
    const proc = exec(`cd ${path} git fetch ${repo} && ${reset ? 'git reset --hard' : 'git pull'} && npm install && ${command}`)
    proc.stdout.on('data', function (data) {
      console.log(data)
    })
    proc.stderr.on('data', function (error) {
      console.log(error)
    })
    return `Redeployed from repository @ ${new Date()}`
  }
  // helper function that rejects unauthorized requests
  function _unauthorized () {
    return h.response('Unauthorized').code(401)
  }
  if (secret) {
    if (!request.headers['x-hub-signature']) {
      return _unauthorized()
    }
    const sig = `sha1=${crypto.createHmac('sha1', secret).update(JSON.stringify(request.payload)).digest('hex')}`
    if (crypto.timingSafeEqual(Buffer.from(sig), Buffer.from(request.headers['x-hub-signature']))) {
      return _exec()
    } else {
      return _unauthorized()
    }
  } else {
    return _exec()
  }
}
</code></pre>
<p>This <code>handler()</code> function first checks to see if the incoming payload has encryption and attempts to decrypt it, if so. If the payload is valid, it updates the local repository (<code>git fetch</code>), reinstalls packages (<code>npm install</code>) and executes a command (or a series of commands) to redeploy the server (<code>${command}</code>).</p>
<p>In order for this to work, you need to set up a corresponding <a href="https://docs.github.com/en/free-pro-team@latest/developers/webhooks-and-events/about-webhooks">webhook on GitHub</a>. On your repository, go to &quot;Settings&quot; then go to &quot;Webhooks&quot;. Click the &quot;Add webhook&quot; button and set up a new webhook that points to your public Esdi server and its port, at the corresponding <code>path</code> from above (e.g., <code> http://my-esdi-server.com:8587/hook/github-redeploy</code>).</p>
<p>Change the &quot;Application type&quot; to <code>application/json</code>. If you're using a <code>secret</code> in your configuration (recommended), then add it here. If your Hook server is using TLS then make sure to direct the traffic to <code>https</code> and enable SSL verification on the webhook. For most use cases, you want to set &quot;Which events would you like to trigger this webhook?&quot; to &quot;Just the <code>push</code> event.&quot; Here's an example configuration:</p>
<p><img src="https://user-images.githubusercontent.com/7295363/101291333-e927a180-37bc-11eb-839f-490da4f2df91.png" alt=""></p>
<p>You can use this particular Hook to automatically redeploy your server while developing your own Esdi bot. Depending on your setup, this can be useful for automatically keeping your live bot in sync with your codebase. Otherwise, you can use this as a guide for your own global Hook ideas!</p>
<p>Next, let's <a href="tutorial-ko-fi-channel-hook-example.html">enable the <code>ko-fi</code> channel Hook</a> for one of our channels.</p>
</article>

</section>

    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Sun Dec 06 2020 15:16:44 GMT-0800 (Pacific Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



    <script src="./jsdoc.js"></script>
    
    <link type="text/css" rel="stylesheet" href="./jsdoc.css">
    
</body>
</html>