<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>hooks/ko-fi.js - Esdi Documentation</title>
    
    <meta name="description" content="ES6 Discord bot framework" />
    
    
    
    <meta property="og:title" content="Esdi Documentation"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://user-images.githubusercontent.com/7295363/97830418-bf410380-1c81-11eb-95cc-1b7b15d8d7eb.jpg"/>
    <meta property="og:site_name" content="Esdi Documentation"/>
    <meta property="og:url" content="https://azigler.github.io/esdi"/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://www.github.com/azigler/esdi" target="_blank" >GitHub</a></h2><h2><a href="https://www.npmjs.com/package/esdi" target="_blank" >npm</a></h2><h2><a href="https://discord.gg/HTSYNQrXam" target="_blank" >Discord</a></h2><h2><a href="https://ko-fi.com/andrewzigler" target="_blank" >Ko-fi</a></h2><h3>Classes</h3><ul><li><a href="BotController.html">BotController</a><ul class='methods'><li data-type='method'><a href="BotController.html#buildEmbed">buildEmbed</a></li><li data-type='method'><a href="BotController.html#buildEmbedFields">buildEmbedFields</a></li><li data-type='method'><a href="BotController.html#buildEmbedFieldValues">buildEmbedFieldValues</a></li><li data-type='method'><a href="BotController.html#buildStatusEmbed">buildStatusEmbed</a></li><li data-type='method'><a href="BotController.html#init">init</a></li><li data-type='method'><a href="BotController.html#login">login</a></li><li data-type='method'><a href="BotController.html#start">start</a></li><li data-type='method'><a href="BotController.html#stop">stop</a></li></ul></li><li><a href="Command.html">Command</a><ul class='members'><li data-type='member'><a href="Command.html#.clean">clean</a></li><li data-type='member'><a href="Command.html#.event">event</a></li><li data-type='member'><a href="Command.html#.help">help</a></li><li data-type='member'><a href="Command.html#.hook">hook</a></li><li data-type='member'><a href="Command.html#.ping">ping</a></li><li data-type='member'><a href="Command.html#.prefix">prefix</a></li><li data-type='member'><a href="Command.html#.reload">reload</a></li><li data-type='member'><a href="Command.html#.status">status</a></li></ul></li><li><a href="CommandController.html">CommandController</a><ul class='methods'><li data-type='method'><a href="CommandController.html#determinePrefix">determinePrefix</a></li><li data-type='method'><a href="CommandController.html#executeCommand">executeCommand</a></li><li data-type='method'><a href="CommandController.html#findCommand">findCommand</a></li><li data-type='method'><a href="CommandController.html#init">init</a></li><li data-type='method'><a href="CommandController.html#start">start</a></li><li data-type='method'><a href="CommandController.html#stop">stop</a></li></ul></li><li><a href="DatabaseController.html">DatabaseController</a><ul class='methods'><li data-type='method'><a href="DatabaseController.html#fetchDoc">fetchDoc</a></li><li data-type='method'><a href="DatabaseController.html#init">init</a></li><li data-type='method'><a href="DatabaseController.html#loadDb">loadDb</a></li><li data-type='method'><a href="DatabaseController.html#start">start</a></li><li data-type='method'><a href="DatabaseController.html#stop">stop</a></li><li data-type='method'><a href="DatabaseController.html#stopSyncing">stopSyncing</a></li><li data-type='method'><a href="DatabaseController.html#updateDoc">updateDoc</a></li></ul></li><li><a href="Esdi.html">Esdi</a><ul class='methods'><li data-type='method'><a href="Esdi.html#determineMemory">determineMemory</a></li><li data-type='method'><a href="Esdi.html#determineProcessor">determineProcessor</a></li><li data-type='method'><a href="Esdi.html#determineUptime">determineUptime</a></li><li data-type='method'><a href="Esdi.html#load">load</a></li><li data-type='method'><a href="Esdi.html#start">start</a></li><li data-type='method'><a href="Esdi.html#stop">stop</a></li></ul></li><li><a href="Event.html">Event</a><ul class='members'><li data-type='member'><a href="Event.html#.guildCreate">guildCreate</a></li><li data-type='member'><a href="Event.html#.guildDelete">guildDelete</a></li><li data-type='member'><a href="Event.html#.guildMemberAdd">guildMemberAdd</a></li><li data-type='member'><a href="Event.html#.guildMemberRemove">guildMemberRemove</a></li><li data-type='member'><a href="Event.html#.process-monitor">process-monitor</a></li><li data-type='member'><a href="Event.html#.rateLimit">rateLimit</a></li><li data-type='member'><a href="Event.html#.ready">ready</a></li></ul></li><li><a href="EventController.html">EventController</a><ul class='methods'><li data-type='method'><a href="EventController.html#fetchEventContext">fetchEventContext</a></li><li data-type='method'><a href="EventController.html#init">init</a></li><li data-type='method'><a href="EventController.html#initializeIfMissing">initializeIfMissing</a></li><li data-type='method'><a href="EventController.html#loop">loop</a></li><li data-type='method'><a href="EventController.html#registerDiscordEvents">registerDiscordEvents</a></li><li data-type='method'><a href="EventController.html#start">start</a></li><li data-type='method'><a href="EventController.html#stop">stop</a></li><li data-type='method'><a href="EventController.html#updateLocalEventContexts">updateLocalEventContexts</a></li></ul></li><li><a href="Guild.html">Guild</a><ul class='methods'><li data-type='method'><a href="Guild.html#.User#serialize">User#serialize</a></li><li data-type='method'><a href="Guild.html#hydrate">hydrate</a></li></ul></li><li><a href="GuildController.html">GuildController</a><ul class='methods'><li data-type='method'><a href="GuildController.html#addGuild">addGuild</a></li><li data-type='method'><a href="GuildController.html#fetchInitialGuilds">fetchInitialGuilds</a></li><li data-type='method'><a href="GuildController.html#init">init</a></li><li data-type='method'><a href="GuildController.html#removeGuild">removeGuild</a></li><li data-type='method'><a href="GuildController.html#start">start</a></li><li data-type='method'><a href="GuildController.html#stop">stop</a></li></ul></li><li><a href="Hook.html">Hook</a><ul class='members'><li data-type='member'><a href="Hook.html#.github-redeploy">github-redeploy</a></li><li data-type='member'><a href="Hook.html#.ko-fi">ko-fi</a></li></ul><ul class='methods'><li data-type='method'><a href="Hook.html#checkEnabledForContext">checkEnabledForContext</a></li></ul></li><li><a href="HookController.html">HookController</a><ul class='methods'><li data-type='method'><a href="HookController.html#init">init</a></li><li data-type='method'><a href="HookController.html#start">start</a></li><li data-type='method'><a href="HookController.html#stop">stop</a></li></ul></li><li><a href="User.html">User</a><ul class='methods'><li data-type='method'><a href="User.html#addGuild">addGuild</a></li><li data-type='method'><a href="User.html#isInGuild">isInGuild</a></li><li data-type='method'><a href="User.html#removeGuild">removeGuild</a></li></ul></li><li><a href="UserController.html">UserController</a><ul class='methods'><li data-type='method'><a href="UserController.html#fetchGuildMembers">fetchGuildMembers</a></li><li data-type='method'><a href="UserController.html#init">init</a></li><li data-type='method'><a href="UserController.html#start">start</a></li><li data-type='method'><a href="UserController.html#stop">stop</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-Client.html">Client</a></li><li><a href="external-Guild.html">Guild</a></li><li><a href="external-GuildMember.html">GuildMember</a></li><li><a href="external-Message.html">Message</a></li><li><a href="external-User.html">User</a></li></ul><h3>Events</h3><ul><li><a href="Esdi.html#event:loop">loop</a></li><li><a href="Esdi.html#event:start">start</a></li><li><a href="Esdi.html#event:stop">stop</a></li><li><a href="external-Client.html#event:event:Client#guildCreate">Client#guildCreate</a></li><li><a href="external-Client.html#event:event:Client#guildDelete">Client#guildDelete</a></li><li><a href="external-Client.html#event:event:Client#guildMemberAdd">Client#guildMemberAdd</a></li><li><a href="external-Client.html#event:event:Client#guildMemberRemove">Client#guildMemberRemove</a></li><li><a href="external-Client.html#event:event:Client#ready">Client#ready</a></li></ul><h3>Namespaces</h3><ul><li><a href="ZigUtils.html">ZigUtils</a><ul class='methods'><li data-type='method'><a href="ZigUtils.html#.capitalize">capitalize</a></li><li data-type='method'><a href="ZigUtils.html#.parseIntervalString">parseIntervalString</a></li></ul></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-adding-a-custom-command.html">Adding a custom command</a></li><li><a href="tutorial-github-redeploy-global-hook-example.html">github-redeploy global Hook example</a></li><li><a href="tutorial-ko-fi-channel-hook-example.html">ko-fi channel Hook example</a></li><li><a href="tutorial-process-monitor-global-interval-event-example.html">process-monitor global interval Event example</a></li><li><a href="tutorial-setting-up-an-esdi-instance.html">Setting up an Esdi instance</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">hooks/ko-fi.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const joi = require('joi')

/**
 * Converts a {@link https://ko-fi.com/|Ko-fi} webhook into a {@link https://discord.js.org/#/docs/main/stable/class/MessageEmbed|discord.js MessageEmbed} and posts it in a channel
 *
 * `POST: /hook/ko-fi/{channel}`
 *
 * @type {Hook}
 * @memberof Hook
 * @name ko-fi
 * @prop {Object} initConfig `init` function configuration object
 * @prop {Esdi} initConfig.server Esdi server instance
 * @tutorial ko-fi-channel-hook-example
 * @static
 */
module.exports = {
  name: 'ko-fi',
  context: 'channel',
  description: 'Converts a Ko-fi webhook into a message embed and posts it in a channel.',
  init (server) {
    return {
      method: 'POST',
      path: '/hook/ko-fi/{channel}',
      handler: async (request, h) => {
        // check if channel exists and is enabled
        const checkChannel = await this.checkEnabledForContext({
          h,
          server,
          contextId: request.params.channel,
          contextType: 'channel'
        })
        if (!checkChannel.id) {
          return checkChannel
        }

        let msg

        // create a webhook
        const channelHook = await checkChannel.createWebhook(
          'Ko-fi',
          { avatar: 'https://user-images.githubusercontent.com/7295363/99930265-49bad700-2d05-11eb-9057-1a013c45ee2c.png' }
        )

        // validate payload
        const kofiSchema = joi.object({
          message_id: joi.string()
            .length(36),
          timestamp: joi.date(),
          type: joi.string()
            .pattern(/(Donation|Commission|Shop Order)/),
          is_public: joi.boolean(),
          from_name: joi.string(),
          message: joi.string()
            .allow(''),
          amount: joi.string(),
          url: joi.string()
            .uri(),
          email: joi.string()
            .allow(null),
          currency: joi.string()
            .allow(null),
          is_subscription_payment: joi.boolean(),
          is_first_subscription_payment: joi.boolean(),
          kofi_transaction_id: joi.string()
        })
        if (!request.payload ||
              !request.payload.data ||
              kofiSchema.validate(JSON.parse(request.payload.data)).error) {
          msg = `Ko-fi Hook for Channel&lt;${request.params.channel}> was rejected due to invalid payload @ ${new Date().toLocaleString()} PT`
          console.log(msg, kofiSchema.validate(JSON.parse(request.payload.data)))
          return h.response(msg).code(400)
        }

        // parse payload
        const parsed = JSON.parse(request.payload.data)

        // check if payload is private
        let isPrivate
        if (parsed.is_public === false) {
          parsed.from_name = 'Anonymous'
          parsed.message = ''

          msg = `Private ko-fi Hook for Channel&lt;${request.params.channel}> was handled @ ${new Date().toLocaleString()} PT`
          isPrivate = true
        }

        // prepare fields for message embed
        const embedFields = [
          {
            name: '**Name**',
            value: parsed.from_name,
            inline: true
          },
          {
            name: '**Amount**',
            value: donationAmount(parsed),
            inline: true
          }
        ]
        if (parsed.message.length > 0) {
          embedFields.push({
            name: '**Message**',
            value: parsed.message
          })
        }

        // build message embed
        const embed = server.controllers.get('BotController').buildEmbed({
          title: '☕ New Ko-fi contribution',
          footerTextType: 'Hook',
          url: parsed.url,
          fields: embedFields,
          hexColor: '#29ABE0',
          thumbnail: {
            url: 'https://user-images.githubusercontent.com/7295363/99930265-49bad700-2d05-11eb-9057-1a013c45ee2c.png'
          }
        })

        // if webhook is public, set result message
        if (!isPrivate) {
          msg = `Ko-fi Hook for Channel&lt;${request.params.channel}> was handled @ ${new Date().toLocaleString()} PT`
        }

        // send the message embed
        channelHook.send({ embeds: [embed] }).then(() => {
          // deletes the webhook after use
          channelHook.delete()
        })

        // announce handling the request successfully
        console.log(msg)
        return h.response(msg).code(200)
      }
    }
  }
}

// helper function that returns the donation amount with a currency symbol
const donationAmount = (parsed) => {
  return `${parsed.currency ? parsed.currency : '$'}${parsed.amount}`
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Sun Dec 27 2020 10:51:48 GMT-0800 (Pacific Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



    <script src="./jsdoc.js"></script>
    
    <link type="text/css" rel="stylesheet" href="./jsdoc.css">
    
</body>
</html>
